# Template file for 'fnm'
pkgname=fnm
version=1.38.1
revision=1
# Upstream only supports these architectures
archs="x86_64* aarch64 armv7l"
build_style=cargo
build_helper=qemu
hostmakedepends="pkg-config"
makedepends="libzstd-devel"
short_desc="Fast and simple Node.js version manager, built in Rust"
maintainer="Vinfall <neptuniah@riseup.net>"
license="GPL-3.0-only"
homepage="https://github.com/Schniz/fnm"
changelog="https://raw.githubusercontent.com/Schniz/fnm/master/CHANGELOG.md"
distfiles="https://github.com/Schniz/fnm/archive/refs/tags/v${version}.tar.gz"
checksum=c24e4c26183a4d88a33e343902ed2d45da23e78c66b2a696a7420eb86deddda9

do_check() {
	# NOTE: downloader::tests are ignored as musl requires env to work
	cargo test --target ${RUST_TARGET} --workspace --locked -- \
		    --skip shell::infer::unix::tests::test_get_process_info \
		    --skip downloader::tests::test_installing_node_12 \
		    --skip downloader::tests::test_installing_npm
}

post_install() {
	# only needed on musl
	if [ "$XBPS_TARGET_MACHINE" = "x86_64-musl" ]; then
		vinstall ${FILESDIR}/fnm.sh 644 etc/profile.d
	fi
	for shell in bash fish zsh; do
		vtargetrun ${DESTDIR}/usr/bin/fnm completions --shell ${shell} > fnm.${shell}
		vcompletion fnm.${shell} ${shell}
	done
}
